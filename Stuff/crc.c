#include <JEO:JEO.h>
#include <exec/memory.h>
#include <proto/dos.h>

typedef struct
{
	ULONG crc32,
	      jeo32;
} JEO_CheckSum;

static ULONG crc_32_tab[] =				 /* CRC polynomial 0xedb88320 */
{
0x00000000, 0x77073096, 0xee0e612c, 0x990951ba, 0x076dc419, 0x706af48f, 0xe963a535, 0x9e6495a3,
0x0edb8832, 0x79dcb8a4, 0xe0d5e91e, 0x97d2d988, 0x09b64c2b, 0x7eb17cbd, 0xe7b82d07, 0x90bf1d91,
0x1db71064, 0x6ab020f2, 0xf3b97148, 0x84be41de, 0x1adad47d, 0x6ddde4eb, 0xf4d4b551, 0x83d385c7,
0x136c9856, 0x646ba8c0, 0xfd62f97a, 0x8a65c9ec, 0x14015c4f, 0x63066cd9, 0xfa0f3d63, 0x8d080df5,
0x3b6e20c8, 0x4c69105e, 0xd56041e4, 0xa2677172, 0x3c03e4d1, 0x4b04d447, 0xd20d85fd, 0xa50ab56b,
0x35b5a8fa, 0x42b2986c, 0xdbbbc9d6, 0xacbcf940, 0x32d86ce3, 0x45df5c75, 0xdcd60dcf, 0xabd13d59,
0x26d930ac, 0x51de003a, 0xc8d75180, 0xbfd06116, 0x21b4f4b5, 0x56b3c423, 0xcfba9599, 0xb8bda50f,
0x2802b89e, 0x5f058808, 0xc60cd9b2, 0xb10be924, 0x2f6f7c87, 0x58684c11, 0xc1611dab, 0xb6662d3d,
0x76dc4190, 0x01db7106, 0x98d220bc, 0xefd5102a, 0x71b18589, 0x06b6b51f, 0x9fbfe4a5, 0xe8b8d433,
0x7807c9a2, 0x0f00f934, 0x9609a88e, 0xe10e9818, 0x7f6a0dbb, 0x086d3d2d, 0x91646c97, 0xe6635c01,
0x6b6b51f4, 0x1c6c6162, 0x856530d8, 0xf262004e, 0x6c0695ed, 0x1b01a57b, 0x8208f4c1, 0xf50fc457,
0x65b0d9c6, 0x12b7e950, 0x8bbeb8ea, 0xfcb9887c, 0x62dd1ddf, 0x15da2d49, 0x8cd37cf3, 0xfbd44c65,
0x4db26158, 0x3ab551ce, 0xa3bc0074, 0xd4bb30e2, 0x4adfa541, 0x3dd895d7, 0xa4d1c46d, 0xd3d6f4fb,
0x4369e96a, 0x346ed9fc, 0xad678846, 0xda60b8d0, 0x44042d73, 0x33031de5, 0xaa0a4c5f, 0xdd0d7cc9,
0x5005713c, 0x270241aa, 0xbe0b1010, 0xc90c2086, 0x5768b525, 0x206f85b3, 0xb966d409, 0xce61e49f,
0x5edef90e, 0x29d9c998, 0xb0d09822, 0xc7d7a8b4, 0x59b33d17, 0x2eb40d81, 0xb7bd5c3b, 0xc0ba6cad,
0xedb88320, 0x9abfb3b6, 0x03b6e20c, 0x74b1d29a, 0xead54739, 0x9dd277af, 0x04db2615, 0x73dc1683,
0xe3630b12, 0x94643b84, 0x0d6d6a3e, 0x7a6a5aa8, 0xe40ecf0b, 0x9309ff9d, 0x0a00ae27, 0x7d079eb1,
0xf00f9344, 0x8708a3d2, 0x1e01f268, 0x6906c2fe, 0xf762575d, 0x806567cb, 0x196c3671, 0x6e6b06e7,
0xfed41b76, 0x89d32be0, 0x10da7a5a, 0x67dd4acc, 0xf9b9df6f, 0x8ebeeff9, 0x17b7be43, 0x60b08ed5,
0xd6d6a3e8, 0xa1d1937e, 0x38d8c2c4, 0x4fdff252, 0xd1bb67f1, 0xa6bc5767, 0x3fb506dd, 0x48b2364b,
0xd80d2bda, 0xaf0a1b4c, 0x36034af6, 0x41047a60, 0xdf60efc3, 0xa867df55, 0x316e8eef, 0x4669be79,
0xcb61b38c, 0xbc66831a, 0x256fd2a0, 0x5268e236, 0xcc0c7795, 0xbb0b4703, 0x220216b9, 0x5505262f,
0xc5ba3bbe, 0xb2bd0b28, 0x2bb45a92, 0x5cb36a04, 0xc2d7ffa7, 0xb5d0cf31, 0x2cd99e8b, 0x5bdeae1d,
0x9b64c2b0, 0xec63f226, 0x756aa39c, 0x026d930a, 0x9c0906a9, 0xeb0e363f, 0x72076785, 0x05005713,
0x95bf4a82, 0xe2b87a14, 0x7bb12bae, 0x0cb61b38, 0x92d28e9b, 0xe5d5be0d, 0x7cdcefb7, 0x0bdbdf21,
0x86d3d2d4, 0xf1d4e242, 0x68ddb3f8, 0x1fda836e, 0x81be16cd, 0xf6b9265b, 0x6fb077e1, 0x18b74777,
0x88085ae6, 0xff0f6a70, 0x66063bca, 0x11010b5c, 0x8f659eff, 0xf862ae69, 0x616bffd3, 0x166ccf45,
0xa00ae278, 0xd70dd2ee, 0x4e048354, 0x3903b3c2, 0xa7672661, 0xd06016f7, 0x4969474d, 0x3e6e77db,
0xaed16a4a, 0xd9d65adc, 0x40df0b66, 0x37d83bf0, 0xa9bcae53, 0xdebb9ec5, 0x47b2cf7f, 0x30b5ffe9,
0xbdbdf21c, 0xcabac28a, 0x53b39330, 0x24b4a3a6, 0xbad03605, 0xcdd70693, 0x54de5729, 0x23d967bf,
0xb3667a2e, 0xc4614ab8, 0x5d681b02, 0x2a6f2b94, 0xb40bbe37, 0xc30c8ea1, 0x5a05df1b, 0x2d02ef8d
};

#define UPDC32(octet, crc) (crc_32_tab[((crc) ^ (octet)) & 0xff] ^ ((crc) >> 8))

static ULONG JEO_crc_32_tab[] =
{
0x00000000, 0xAFC5E5F3, 0xF04E2E15, 0x5F8BCBE6, 0x4F59B9D9, 0xE09C5C2A, 0xBF1797CC, 0x10D2723F, 
0x9EB373B2, 0x31769641, 0x6EFD5DA7, 0xC138B854, 0xD1EACA6B, 0x7E2F2F98, 0x21A4E47E, 0x8E61018D, 
0x92A30297, 0x3D66E764, 0x62ED2C82, 0xCD28C971, 0xDDFABB4E, 0x723F5EBD, 0x2DB4955B, 0x827170A8, 
0x0C107125, 0xA3D594D6, 0xFC5E5F30, 0x539BBAC3, 0x4349C8FC, 0xEC8C2D0F, 0xB307E6E9, 0x1CC2031A, 
0x8A83E0DD, 0x2546052E, 0x7ACDCEC8, 0xD5082B3B, 0xC5DA5904, 0x6A1FBCF7, 0x35947711, 0x9A5192E2, 
0x1430936F, 0xBBF5769C, 0xE47EBD7A, 0x4BBB5889, 0x5B692AB6, 0xF4ACCF45, 0xAB2704A3, 0x04E2E150, 
0x1820E24A, 0xB7E507B9, 0xE86ECC5F, 0x47AB29AC, 0x57795B93, 0xF8BCBE60, 0xA7377586, 0x08F29075, 
0x869391F8, 0x2956740B, 0x76DDBFED, 0xD9185A1E, 0xC9CA2821, 0x660FCDD2, 0x39840634, 0x9641E3C7, 
0xBAC22449, 0x1507C1BA, 0x4A8C0A5C, 0xE549EFAF, 0xF59B9D90, 0x5A5E7863, 0x05D5B385, 0xAA105676, 
0x247157FB, 0x8BB4B208, 0xD43F79EE, 0x7BFA9C1D, 0x6B28EE22, 0xC4ED0BD1, 0x9B66C037, 0x34A325C4, 
0x286126DE, 0x87A4C32D, 0xD82F08CB, 0x77EAED38, 0x67389F07, 0xC8FD7AF4, 0x9776B112, 0x38B354E1, 
0xB6D2556C, 0x1917B09F, 0x469C7B79, 0xE9599E8A, 0xF98BECB5, 0x564E0946, 0x09C5C2A0, 0xA6002753, 
0x3041C494, 0x9F842167, 0xC00FEA81, 0x6FCA0F72, 0x7F187D4D, 0xD0DD98BE, 0x8F565358, 0x2093B6AB, 
0xAEF2B726, 0x013752D5, 0x5EBC9933, 0xF1797CC0, 0xE1AB0EFF, 0x4E6EEB0C, 0x11E520EA, 0xBE20C519, 
0xA2E2C603, 0x0D2723F0, 0x52ACE816, 0xFD690DE5, 0xEDBB7FDA, 0x427E9A29, 0x1DF551CF, 0xB230B43C, 
0x3C51B5B1, 0x93945042, 0xCC1F9BA4, 0x63DA7E57, 0x73080C68, 0xDCCDE99B, 0x8346227D, 0x2C83C78E, 
0xDA41AD61, 0x75844892, 0x2A0F8374, 0x85CA6687, 0x951814B8, 0x3ADDF14B, 0x65563AAD, 0xCA93DF5E, 
0x44F2DED3, 0xEB373B20, 0xB4BCF0C6, 0x1B791535, 0x0BAB670A, 0xA46E82F9, 0xFBE5491F, 0x5420ACEC, 
0x48E2AFF6, 0xE7274A05, 0xB8AC81E3, 0x17696410, 0x07BB162F, 0xA87EF3DC, 0xF7F5383A, 0x5830DDC9, 
0xD651DC44, 0x799439B7, 0x261FF251, 0x89DA17A2, 0x9908659D, 0x36CD806E, 0x69464B88, 0xC683AE7B, 
0x50C24DBC, 0xFF07A84F, 0xA08C63A9, 0x0F49865A, 0x1F9BF465, 0xB05E1196, 0xEFD5DA70, 0x40103F83, 
0xCE713E0E, 0x61B4DBFD, 0x3E3F101B, 0x91FAF5E8, 0x812887D7, 0x2EED6224, 0x7166A9C2, 0xDEA34C31, 
0xC2614F2B, 0x6DA4AAD8, 0x322F613E, 0x9DEA84CD, 0x8D38F6F2, 0x22FD1301, 0x7D76D8E7, 0xD2B33D14, 
0x5CD23C99, 0xF317D96A, 0xAC9C128C, 0x0359F77F, 0x138B8540, 0xBC4E60B3, 0xE3C5AB55, 0x4C004EA6, 
0x60838928, 0xCF466CDB, 0x90CDA73D, 0x3F0842CE, 0x2FDA30F1, 0x801FD502, 0xDF941EE4, 0x7051FB17, 
0xFE30FA9A, 0x51F51F69, 0x0E7ED48F, 0xA1BB317C, 0xB1694343, 0x1EACA6B0, 0x41276D56, 0xEEE288A5, 
0xF2208BBF, 0x5DE56E4C, 0x026EA5AA, 0xADAB4059, 0xBD793266, 0x12BCD795, 0x4D371C73, 0xE2F2F980, 
0x6C93F80D, 0xC3561DFE, 0x9CDDD618, 0x331833EB, 0x23CA41D4, 0x8C0FA427, 0xD3846FC1, 0x7C418A32, 
0xEA0069F5, 0x45C58C06, 0x1A4E47E0, 0xB58BA213, 0xA559D02C, 0x0A9C35DF, 0x5517FE39, 0xFAD21BCA, 
0x74B31A47, 0xDB76FFB4, 0x84FD3452, 0x2B38D1A1, 0x3BEAA39E, 0x942F466D, 0xCBA48D8B, 0x64616878, 
0x78A36B62, 0xD7668E91, 0x88ED4577, 0x2728A084, 0x37FAD2BB, 0x983F3748, 0xC7B4FCAE, 0x6871195D, 
0xE61018D0, 0x49D5FD23, 0x165E36C5, 0xB99BD336, 0xA949A109, 0x068C44FA, 0x59078F1C, 0xF6C26AEF
};

#define JEO_UPDC32(octet, crc) (JEO_crc_32_tab[((crc) ^ (octet)) & 0xff] ^ ((crc) >> 8))

JEO_CheckSum Calculate_CRC (UBYTE *Buffer, ULONG size)
{
	JEO_CheckSum ret;
	UBYTE c;
	LONG chk;
	ULONG i;
	char test[12];

	ret.crc32 = 0xFFFFFFFF;
	ret.jeo32 = 0xFFFFFFFF;
	chk = 0;

	for (i = 0; i < size; i++)
	{
		c = Buffer[i];

		if (chk < 4)
		{
			ret.crc32 = UPDC32 (c, ret.crc32);
			ret.jeo32 = JEO_UPDC32 (c, ret.jeo32);
		}
		else
		{
			test[chk - 4] = c;
			test[chk - 3] = 0;
			chk++;
			if (chk == 14)
				chk = 0;
		}
		if (chk == 3)
		{
			if (c == 27)
				chk++;
			else
				chk = 0;
		}
		if (chk == 2)
		{
			if (c == 64)
				chk++;
			else
				chk = 0;
		}
		if (chk == 1)
		{
			if (c == 167)
				chk++;
			else
				chk=0;
		}
		if (!chk AND c == 112)
			chk++;
	}

	ret.crc32 = ~ret.crc32;
	ret.jeo32 = ~ret.jeo32;
	return (ret);
}

#define LEN 10

main ()
{
	JEO_CheckSum check;
	char *Test;
	ULONG i, j, c, p;
	BPTR fh;
	char FileName[LEN];
	ULONG check1;

	Test = AllocMem (LEN, MEMF_PUBLIC);
	for (j = 0, c = 0, p = 0;; j++, p++)
	{
		if (p == 0x888 OR j == 0)
		{
			printf ("$%08lX (%ld)\r", j, c);
			p = 0;
		}
		for (i = 0; i < LEN; i++)
			Test[i] = FastRnd (256);
		check = Calculate_CRC (Test, LEN);
		if (j == 0)
			check1 = check.crc32;
		if (check.crc32 == check1)
		{
			sprintf (FileName, "RAM:Test%03ld", c+1);
			fh = Open (FileName, MODE_NEWFILE);
			Write (fh, Test, LEN);
			Close (fh);
			printf ("\n%08lX\n%08lX\n\n", check.crc32, check.jeo32);
			c++;
		}
	}
	FreeMem (Test, 50);
}
